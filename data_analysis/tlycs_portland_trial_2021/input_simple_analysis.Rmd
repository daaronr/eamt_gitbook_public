# TLYCS Portland trial: background, data input, brief report

## The trial

In December 2021, TLYCS ran a YouTube advertising campaign in single city, involving 'donation advice'. The top 10% household income households were targeted with (one of?) three categories of videos.

The details are presented in our (currently private) gitbook [HERE](https://app.gitbook.com/o/-MfFk4CTSGwVOPkwnRgx/s/-Mf8cHxdwePMZXRTKnEE/contexts-and-environments-for-testing/tlycs/advisor-signup-portland)

## Capturing data

I (David Reinstein) did a manual 'create report and download' in TLYCS google analytics, basically as described [here](https://app.gitbook.com/o/-MfFk4CTSGwVOPkwnRgx/s/-Mf8cHxdwePMZXRTKnEE/methodological-discussion/implementation-and-collecting-data-issues/google-analytics-interface)

The report and it's parameters can be accessed [here](https://analytics.google.com/analytics/web/#/my-reports/mmZsQ-HMSbCwiG5hjQhWhQ/a10056556w22050110p185278310/_u.date00=20211203&_u.date01=20211231&_u.date10=20201203&_u.date11=20201231&197-table.advFilter=%5B%5B1,%22analytics.totalVisitors%22,%22GT%22,%220%22,0%5D%5D&197-table.plotKeys=%5B%5D&197-table.rowCount=5000&197-table-dataTable.sortColumnName=analytics.totalVisitors&197-table-dataTable.sortDescending=false&197-graphOptions.primaryConcept=analytics.totalVisitors&197-graphOptions.compareConcept=analytics.visits), if you have access. 


Report:

- 3-31 December 2021 vs prior year, same dates
- All North American cities with 1 or more user
- Counts: Users, sessions, certain types of conversions (see below)

I downloaded this as an Excel spreadsheet

`effective_giving_market_testing/data_do_not_commit/tlycs/tlycs_dec_2021_vs_2020_by_city_n_america_pos_users.xlsx`

(This is gitignored so it won't be 'committed' to our repo, at least for now)

## Input and clean data

```{r}

#tl21 <- read_excel(here::here("data_do_not_commit", "tlycs", "tlycs_dec_2021_vs_2020_by_city_n_america.xlsx"), sheet = "Dataset1") #this should have worked?

tl21 <- readxl::read_excel("~/githubs/effective_giving_market_testing/data_do_not_commit/tlycs/tlycs_dec_2021_vs_2020_by_city_n_america.xlsx",  sheet = "Dataset1") %>% 
as_tibble()


```

Create 'year' feature

```{r}

tl21 <- tl21 %>% mutate(
  year = case_when(
    str_detect(`Date Range`, "2021") == TRUE ~ 2021,
    str_detect(`Date Range`, "2020") == TRUE ~ 2020
  )
)

```

Create 'differences across years' features.

```{r}

```


Need to re-label the 'correct' Portland (we think), as this is a common city name.^[And there are two other 'Portlands', each with a small number of sessions]

```{r}

tl21 %>% filter(City=="Portland") %>% dplyr::select(City, year, Users)

```

Presumably the largest one is Portland Oregon, and we'll relable it as such. 

```{r}
tl21 <- tl21 %>%
  mutate(
    City = case_when(City=="Portland" & Users>20 ~ "Portland_OR",
              City=="Portland" ~ "Other_Portland",
              TRUE ~ City)
  )
  
```



## Exploratory analysis

## Casual/simple 'uptick' analysis

Overall versus without Portland
```{r}
tl21 %>% sumtab(Users, year, caption="All N. Amer. cities")
tl21 %>% filter(!City=="Portland_OR") %>% sumtab(Users, year, caption="N. Amer. Cities other than Portland")

tl21 %>% filter(Users>20) %>% sumtab(Users, year, caption="All N. Amer., where Users>20") #Fix -- filter on over 20 users for 2020 ONLY]

tl21 %>% sumtab(Sessions, year, caption="Sessions by year, all")

OR_users_21 <- tl21 %>% dplyr::filter(City=="Portland_OR" & year==2021) %>% select('Users') %>% pull() 

OR_users_20 <- tl21 %>% dplyr::filter(City=="Portland_OR" & year==2020) %>% select('Users') %>% pull() 

OR_uptick <- OR_users_21 - OR_users_20

nonOR  <- tl21 %>% dplyr::filter(City!="Portland_OR") %>% select('Users', year) 

nonOR_users_21 <- mean(nonOR$Users[nonOR$year==2021])
nonOR_users_20 <- mean(nonOR$Users[nonOR$year==2020])

nonOR_uptick <- (nonOR_users_21 - nonOR_users_20)/nonOR_users_20
```

(As in interactive Gitbook)


### Bound: Maximum impact/minimum cost (subject to random variation) 


.. See (todo: integrate in) update hand-calculated results in Gitbook [HERE](https://app.gitbook.com/o/-MfFk4CTSGwVOPkwnRgx/s/-Mf8cHxdwePMZXRTKnEE/contexts-and-environments-for-testing/tlycs/advisor-signup-portland/results-first-pass))

(Hand-input for now...)

Lower bound on cost of \$13.07 per user (\$10.28 per visit) if all visits were generated by ad. 

\$24.69 cost per user if Portland was 'same as last year'


### Difference in Differences comparison to other cities

Guiding assumptions:

- the cities used are fairly representative

- 'uptick as a percentage' is unrelated to city size/visits last year
all the cities in the comparison group are 'informative to the counterfactual' in proportion to their total number of sessions (I'm waving the hands a bit here)

Thus

`r 100*(OR_users_21 - OR_users_20)/OR_users_20`% visits uptick (YoY) for Portland in 2020

For 'all North American cities other than Portland (with positive users in either year): 

The average is `r op(mean(nonOR$Users[nonOR$year==2020]))`  users in the 2020 period and `r op(mean(nonOR$Users[nonOR$year==2021]))` users in the 2021 period, an uptick of `r op(nonOR_users_21)`
- `r op(nonOR_users_20)`)/`r op(nonOR_users_20)` = about `r op(100*nonOR_uptick)`%.


`r op(100*nonOR_uptick)`% uptick $\times$ `r OR_users_20` = `r op(nonOR_uptick*OR_users_20)` 'counterfactual uptic' in users for Portland

`r OR_users_21 - OR_users_20` -`r op(nonOR_uptick*OR_users_20)` = `r op(OR_users_21 - OR_users_20 - nonOR_uptick*OR_users_20)`  'uptick relative to counterfactual'

```{r}
or_uptick_vs_cfl <- OR_users_21 - OR_users_20 - nonOR_uptick*OR_users_20
```

USD 4000 /`r op(or_uptick_vs_cfl)`  = USD `r op(4000/or_uptick_vs_cfl)`  cost per user

This seems realistic at a first-pass (but it may be better to focus on a narrower comparison group) 



